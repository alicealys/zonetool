#include "stdafx.hpp"

namespace ZoneTool
{
	namespace H1
	{
		namespace
		{
			bool is_map_image(const std::string& name)
			{
				return (name.size() >= 6)
					? ((name.substr(0, 6) == "*light" || name.substr(0, 6) == "*refle" ||
						name == "$outdoor")
						? true
						: false)
					: false;
			}

			std::string clean_name(const std::string& name)
			{
				auto new_name = name;

				for (auto i = 0u; i < name.size(); i++)
				{
					switch (new_name[i])
					{
					case '*':
						new_name[i] = '_';
						break;
					}
				}

				return new_name;
			}
		}

		void IGfxImage::dump(GfxImage* asset)
		{
			auto path = "images\\"s + clean_name(asset->name) + ".h2Image"s;
			assetmanager::dumper write;
			if (!write.open(path))
			{
				return;
			}

			if (asset->semantic == 11)
			{
				ZONETOOL_WARNING("GfxImage (%s) was not dumped succesfully!", asset->name);
				write.close();
				return;
			}

			write.dump_single(asset);
			write.dump_string(asset->name);

			if (asset->pixelData)
			{
				write.dump_array(asset->pixelData, asset->dataLen1);
			}

			if (asset->streamed)
			{
				throw std::runtime_error("streamed image?");
				__debugbreak();
			}
			write.close();
		}
	}
}